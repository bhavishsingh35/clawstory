{% extends "base.html" %}

{% block title %}Complete Payment | ClawStory{% endblock %}
{% block meta_description %}
Secure online payment for your ClawStory order using Stripe.
{% endblock %}

{% block content %}
<div class="min-h-[80vh] flex items-center justify-center bg-gray-100 px-3 sm:px-4">

  <div class="w-full max-w-lg bg-white rounded-3xl shadow-xl p-6 sm:p-8">

    <!-- ================= HEADER ================= -->
    <div class="text-center mb-6">
      <h1 class="text-xl sm:text-2xl font-extrabold">
        Complete Payment
      </h1>
      <p class="text-sm text-gray-500 mt-1">
        Secure payment powered by Stripe
      </p>
    </div>

    <!-- ================= ORDER INFO ================= -->
    <div class="bg-gray-50 rounded-2xl p-4 sm:p-5 mb-6 text-sm">
      <div class="flex justify-between mb-2 gap-4">
        <span class="text-gray-500">Order</span>
        <span class="font-semibold">{{ order.order_number }}</span>
      </div>

      <div class="flex justify-between mb-2">
        <span class="text-gray-500">Amount</span>
        <span class="font-semibold">
          â‚¹{{ order.total_amount|floatformat:2 }}
        </span>
      </div>

      <div class="flex justify-between">
        <span class="text-gray-500">Payment Method</span>
        <span class="font-semibold">UPI / Cards / Wallets</span>
      </div>
    </div>

    <!-- ================= STRIPE FORM ================= -->
    <form id="payment-form" class="space-y-4">
      <div id="payment-element" class="p-3 border rounded-xl bg-white"></div>

      <button
        id="submit"
        type="submit"
        class="w-full bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition min-h-[48px]"
      >
        <span id="button-text">Pay Securely</span>
      </button>

      <p
        id="payment-message"
        class="hidden text-sm text-red-600 text-center"
      ></p>
    </form>

    <!-- ================= TRUST ================= -->
    <div class="mt-6 text-xs text-gray-500 text-center space-y-1">
      <p>ðŸ”’ PCI-DSS compliant payments</p>
      <p>ðŸ’³ Powered by Stripe</p>
      <p>ðŸ“© Confirmation via email after payment</p>
    </div>

  </div>

</div>

<!-- ================= STRIPE ================= -->
<script src="https://js.stripe.com/v3/"></script>

<script>
(function () {
  const stripe = Stripe("{{ stripe_public_key }}");
  const clientSecret = "{{ client_secret }}";

  const elements = stripe.elements({
    clientSecret: clientSecret,
    appearance: { theme: "stripe" },
  });

  const paymentElement = elements.create("payment");
  paymentElement.mount("#payment-element");

  const form = document.getElementById("payment-form");
  const submitButton = document.getElementById("submit");
  const buttonText = document.getElementById("button-text");
  const message = document.getElementById("payment-message");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    submitButton.disabled = true;
    buttonText.textContent = "Processingâ€¦";
    message.classList.add("hidden");

    const { error } = await stripe.confirmPayment({
      elements,
      confirmParams: {
        return_url: "{{ request.scheme }}://{{ request.get_host }}{% url 'orders:order_success' order.id %}",
      },
    });

    if (error) {
      message.textContent =
        error.message || "Payment failed. Please try again.";
      message.classList.remove("hidden");
      submitButton.disabled = false;
      buttonText.textContent = "Pay Securely";
    }
  });
})();
</script>

{% endblock %}
